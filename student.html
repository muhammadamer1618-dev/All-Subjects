<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>شهادة الطالب - مدارس الفلاح الأهلية</title>
<link href='https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap' rel='stylesheet'>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Calibri;background:#f6f6f6;margin:0;padding:25px}
h1,h2{text-align:center;margin:0}
h1{color:#1976d2;font-size:30px}
h2{color:#d32f2f;font-size:22px;margin-top:5px}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:18px}
th,td{border:1px solid #000;text-align:center;padding:8px}
th{background:#1976d2;color:#fff}
.btn{width:100%;padding:14px;border:none;border-radius:8px;font-size:18px;margin-bottom:10px;cursor:pointer}
.view{background:#1976d2;color:#fff}
.print{background:#388e3c;color:#fff}
.back{background:#555;color:#fff}
@media print{.btn,#code{display:none}}
</style>
</head>
<body>

<input id="code" placeholder="ادخل كود الطالب" class="btn" style="border:1px solid #999">
<button onclick="loadData()" class="btn view">عرض</button>
<button onclick="window.print()" class="btn print">طباعة</button>
<button onclick="location='index.html'" class="btn back">الصفحة الرئيسية</button>

<div id="cert" style="display:none">
  <h1>مدارس الفلاح الأهلية</h1>
  <h2>شهادة درجات الطالب في جميع المواد</h2>

  <table>
    <tr><td>اسم الطالب</td><td id="st_name"></td></tr>
    <tr><td>الصف</td><td id="st_grade"></td></tr>
    <tr><td>الشعبة</td><td id="st_section"></td></tr>
  </table>

  <h2 style="color:#1976d2;margin-top:20px">درجات المواد</h2>

  <table id="subjectsTable">
    <thead>
      <tr>
        <th>المادة</th>
        <th>نوع الاختبار</th>
        <th>الدرجة النهائية</th>
        <th>درجة الطالب</th>
        <th>التقدير</th>
        <th>اسم المعلم</th>
        <th>مشرف المادة</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3 id="summary" style="text-align:center;margin-top:15px;color:#1976d2"></h3>

  <table style="margin-top:25px">
    <tr>
      <td>رئيس قسم الإشراف</td>
      <td>مدير المدرسة</td>
    </tr>
    <tr>
      <td>أحمد سمير عباس</td>
      <td>سعيد بن علي الجمعان</td>
    </tr>
  </table>
</div>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyC4-cGVb2pHwo6LYiD-UoWtmEEZKQxj4_M",
  authDomain: "all-subjects-14322.firebaseapp.com",
  projectId: "all-subjects-14322",
  storageBucket: "all-subjects-14322.firebasestorage.app",
  messagingSenderId: "813955287168",
  appId: "1:813955287168:web:07efa7dde95b117b9bbe65"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

function calcRating(mark, full){
  var m = Number(mark);
  var f = Number(full);
  if(!m || !f) return "—";
  var p = (m/f)*100;
  if(p>=90) return "ممتاز";
  if(p>=80) return "جيد جدًا";
  if(p>=70) return "جيد";
  if(p>=60) return "مقبول";
  return "ضعيف";
}

async function loadData(){
  var code = document.getElementById('code').value.trim();
  if(!code){
    alert("ادخل كود الطالب");
    return;
  }

  try{
    var doc = await db.collection("students").doc(code).get();
    if(!doc.exists){
      alert("الكود غير موجود");
      return;
    }
    var st = doc.data();

    document.getElementById('cert').style.display = "block";
    document.getElementById('st_name').innerText = st.name || "";
    document.getElementById('st_grade').innerText = st.grade || "";
    document.getElementById('st_section').innerText = st.section || "";

    var tbody = document.querySelector("#subjectsTable tbody");
    tbody.innerHTML = "";

    var totalMark = 0;
    var totalFull = 0;

    if(st.subjects){
      if(Array.isArray(st.subjects)){
        st.subjects.forEach(function(sub){
          renderSubjectRow(tbody, sub.subjectName || "", sub);
          totalMark += Number(sub.mark || 0);
          totalFull += Number(sub.fullMark || 0);
        });
      }else{
        Object.keys(st.subjects).forEach(function(key){
          var sub = st.subjects[key];
          renderSubjectRow(tbody, key, sub);
          totalMark += Number(sub.mark || 0);
          totalFull += Number(sub.fullMark || 0);
        });
      }
    }

    var percent = totalFull > 0 ? (totalMark/totalFull)*100 : 0;
    var overall = "";
    if(totalFull === 0){
      overall = "—";
    }else if(percent>=90) overall = "ممتاز";
    else if(percent>=80) overall = "جيد جدًا";
    else if(percent>=70) overall = "جيد";
    else if(percent>=60) overall = "مقبول";
    else overall = "ضعيف";

    document.getElementById("summary").innerText =
      "المجموع الكلي: "+totalMark+"/"+totalFull+" — التقدير العام: "+overall;

  }catch(e){
    alert("خطأ في قراءة بيانات الطالب");
    console.log(e);
  }
}

function renderSubjectRow(tbody, name, sub){
  var tr = document.createElement("tr");
  tr.innerHTML =
    "<td>"+(name||"")+"</td>"+
    "<td>"+(sub.exam||"")+"</td>"+
    "<td>"+(sub.fullMark||"")+"</td>"+
    "<td>"+(sub.mark||"")+"</td>"+
    "<td>"+(sub.rating||calcRating(sub.mark, sub.fullMark))+"</td>"+
    "<td>"+(sub.teacher||"")+"</td>"+
    "<td>"+(sub.supervisor||"")+"</td>";
  tbody.appendChild(tr);
}
</script>

</body>
</html>
