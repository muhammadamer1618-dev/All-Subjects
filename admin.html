<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المشرف - مدارس الفلاح الأهلية</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Calibri;
  background:#f4f4f4;
  margin:0;
}
.header{
  background:#1976d2;
  color:#fff;
  text-align:center;
  padding:15px;
}
.header h1{
  margin:0;
  font-size:24px;
}
.header h2{
  margin:5px 0 0;
  font-size:18px;
  color:#ffeb3b;
}
.container{
  max-width:1100px;
  margin:20px auto;
  padding:10px;
}
.box{
  background:#fff;
  border-radius:10px;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 0 8px rgba(0,0,0,0.1);
}
h3{
  margin-top:0;
  color:#1976d2;
}
label{
  display:block;
  margin-top:5px;
}
input,select,button{
  font-family:Calibri;
  font-size:16px;
  padding:8px;
  margin-top:5px;
  border-radius:6px;
  border:1px solid #999;
  box-sizing:border-box;
}
input,select{
  width:100%;
}
button{
  cursor:pointer;
  font-weight:bold;
}
.btn-primary{background:#1976d2;color:#fff;border:none}
.btn-secondary{background:#757575;color:#fff;border:none}
.btn-danger{background:#d32f2f;color:#fff;border:none}
.btn-save{
  width:100%;
  padding:12px;
  margin-top:10px;
  background:#388e3c;
  color:#fff;
  border:none;
  border-radius:10px;
  font-size:18px;
}
.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.col-3{flex:1 1 23%}
.col-4{flex:1 1 30%}
.col-6{flex:1 1 48%}
.col-12{flex:1 1 100%}
@media(max-width:768px){
  .col-3,.col-4,.col-6{flex:1 1 100%}
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
}
th,td{
  border:1px solid #000;
  text-align:center;
  padding:6px;
}
th{
  background:#1976d2;
  color:#fff;
}
.small-btn{
  padding:4px 8px;
  font-size:12px;
}
</style>
</head>
<body>

<div class="header">
  <h1>مدارس الفلاح الأهلية</h1>
  <h2>لوحة المشرف لإدخال درجات الطالب في جميع المواد</h2>
</div>

<div class="container">

  <div class="box">
    <h3>بيانات الطالب</h3>
    <div class="row">
      <div class="col-3">
        <label>كود الطالب</label>
        <input id="st_code" placeholder="مثال: 1001">
      </div>
      <div class="col-3">
        <label>اسم الطالب</label>
        <input id="st_name" placeholder="اسم الطالب">
      </div>
      <div class="col-3">
        <label>الصف</label>
        <select id="st_grade"></select>
      </div>
      <div class="col-3">
        <label>الشعبة</label>
        <select id="st_section">
          <option value="أ">أ</option>
          <option value="ب">ب</option>
          <option value="ج">ج</option>
          <option value="د">د</option>
          <option value="هـ">هـ</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col-4">
        <button class="btn-primary" onclick="saveStudent()">حفظ بيانات الطالب والمواد</button>
      </div>
      <div class="col-4">
        <button class="btn-secondary" onclick="loadStudentByCode()">تحميل بيانات الطالب</button>
      </div>
      <div class="col-4">
        <button class="btn-secondary" onclick="clearForm()">تفريغ النموذج</button>
      </div>
    </div>
  </div>

  <div class="box">
    <h3>مواد الطالب ودرجاته</h3>
    <button class="btn-secondary" onclick="addSubjectRow()">إضافة مادة</button>
    <table>
      <thead>
        <tr>
          <th>المادة</th>
          <th>نوع الاختبار</th>
          <th>الدرجة النهائية</th>
          <th>درجة الطالب</th>
          <th>التقدير</th>
          <th>اسم المعلم</th>
          <th>مشرف المادة</th>
          <th>إزالة</th>
        </tr>
      </thead>
      <tbody id="subjects_body"></tbody>
    </table>
  </div>

  <div class="box">
    <h3>عرض سريع للطالب بالكود</h3>
    <div class="row">
      <div class="col-4">
        <input id="filter_code" placeholder="ادخل كود الطالب">
      </div>
      <div class="col-4">
        <button class="btn-primary" onclick="quickView()">عرض بيانات الطالب</button>
      </div>
    </div>
    <div id="quick_result" style="margin-top:10px;font-size:14px"></div>
  </div>

  <div class="box">
    <button class="btn-secondary" onclick="location='index.html'">الصفحة الرئيسية</button>
    <button class="btn-secondary" onclick="location='student.html'">صفحة الطالب</button>
  </div>

</div>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyC4-cGVb2pHwo6LYiD-UoWtmEEZKQxj4_M",
  authDomain: "all-subjects-14322.firebaseapp.com",
  projectId: "all-subjects-14322",
  storageBucket: "all-subjects-14322.firebasestorage.app",
  messagingSenderId: "813955287168",
  appId: "1:813955287168:web:07efa7dde95b117b9bbe65"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

var gradesList = [
  "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
  "1 متوسط","2 متوسط","3 متوسط",
  "1 ثانوي","2 ثانوي","3 ثانوي"
];

function initSelects(){
  var stGrade = document.getElementById('st_grade');
  gradesList.forEach(function(g){
    var o = document.createElement("option");
    o.value = g; o.textContent = g;
    stGrade.appendChild(o);
  });
  stGrade.value = gradesList[0];
}

function calcRating(mark, full){
  var m = Number(mark);
  var f = Number(full);
  if(!m || !f) return "";
  var p = (m/f)*100;
  if(p>=90) return "ممتاز";
  if(p>=80) return "جيد جدًا";
  if(p>=70) return "جيد";
  if(p>=60) return "مقبول";
  return "ضعيف";
}

function clearForm(){
  document.getElementById('st_code').value = "";
  document.getElementById('st_name').value = "";
  document.getElementById('st_grade').value = gradesList[0];
  document.getElementById('st_section').value = "أ";
  document.getElementById('subjects_body').innerHTML = "";
  addSubjectRow();
}

function addSubjectRow(subjectData){
  var tbody = document.getElementById('subjects_body');
  var tr = document.createElement("tr");

  var subjName = subjectData && subjectData.subjectName ? subjectData.subjectName : "";
  var examType = subjectData && subjectData.examType ? subjectData.examType : (subjectData.exam || "");
  var fullMark = subjectData && subjectData.fullMark != null ? subjectData.fullMark : (subjectData.fullMark || "");
  var mark = subjectData && subjectData.mark != null ? subjectData.mark : (subjectData.mark || "");
  var teacher = subjectData && subjectData.teacher ? subjectData.teacher : "";
  var supervisor = subjectData && subjectData.supervisor ? subjectData.supervisor : "";
  var rating = calcRating(mark, fullMark);

  tr.innerHTML =
    "<td><input class='sub-name' value='"+subjName+"'></td>"+
    "<td><input class='sub-exam' value='"+examType+"'></td>"+
    "<td><input type='number' class='sub-full' value='"+(fullMark!==undefined?fullMark:"")+"'></td>"+
    "<td><input type='number' class='sub-mark' value='"+(mark!==undefined?mark:"")+"'></td>"+
    "<td class='sub-rating'>"+rating+"</td>"+
    "<td><input class='sub-teacher' value='"+teacher+"'></td>"+
    "<td><input class='sub-supervisor' value='"+supervisor+"'></td>"+
    "<td><button class='small-btn btn-danger' onclick='deleteRow(this)'>حذف</button></td>";

  tbody.appendChild(tr);

  var fullInput = tr.querySelector(".sub-full");
  var markInput = tr.querySelector(".sub-mark");

  function updateRating(){
    tr.querySelector(".sub-rating").innerText = calcRating(markInput.value, fullInput.value);
  }
  fullInput.addEventListener("input", updateRating);
  markInput.addEventListener("input", updateRating);
}

function deleteRow(btn){
  var tr = btn.parentNode.parentNode;
  tr.parentNode.removeChild(tr);
}

async function saveStudent(){
  var code = document.getElementById('st_code').value.trim();
  var name = document.getElementById('st_name').value.trim();
  var grade = document.getElementById('st_grade').value;
  var section = document.getElementById('st_section').value;

  if(!code || !name){
    alert("يرجى إدخال كود الطالب واسم الطالب");
    return;
  }

  var rows = document.querySelectorAll("#subjects_body tr");
  var subjects = {};

  rows.forEach(function(tr){
    var subj = tr.querySelector(".sub-name").value.trim();
    if(!subj) return;
    var exam = tr.querySelector(".sub-exam").value.trim();
    var fullMark = Number(tr.querySelector(".sub-full").value);
    var mark = Number(tr.querySelector(".sub-mark").value);
    var rating = tr.querySelector(".sub-rating").innerText;
    var teacher = tr.querySelector(".sub-teacher").value.trim();
    var supervisor = tr.querySelector(".sub-supervisor").value.trim();

    subjects[subj] = {
      exam: exam,
      fullMark: isNaN(fullMark)?0:fullMark,
      mark: isNaN(mark)?0:mark,
      rating: rating,
      teacher: teacher,
      supervisor: supervisor
    };
  });

  if(Object.keys(subjects).length===0){
    alert("يرجى إدخال مادة واحدة على الأقل");
    return;
  }

  try{
    await db.collection("students").doc(code).set({
      code: code,
      name: name,
      grade: grade,
      section: section,
      subjects: subjects
    });
    alert("تم حفظ بيانات الطالب والمواد بنجاح");
  }catch(e){
    alert("حدث خطأ أثناء الحفظ");
    console.log(e);
  }
}

async function loadStudentByCode(){
  var code = document.getElementById('st_code').value.trim();
  if(!code){
    alert("يرجى إدخال كود الطالب أولاً");
    return;
  }
  try{
    var doc = await db.collection("students").doc(code).get();
    if(!doc.exists){
      alert("الطالب غير موجود");
      return;
    }
    var st = doc.data();
    document.getElementById('st_name').value = st.name || "";
    document.getElementById('st_grade').value = st.grade || gradesList[0];
    document.getElementById('st_section').value = st.section || "أ";

    var tbody = document.getElementById('subjects_body');
    tbody.innerHTML = "";
    if(st.subjects){
      if(Array.isArray(st.subjects)){
        st.subjects.forEach(function(sub){
          addSubjectRow(sub);
        });
      }else{
        Object.keys(st.subjects).forEach(function(key){
          var sub = st.subjects[key];
          sub.subjectName = key;
          addSubjectRow(sub);
        });
      }
    }else{
      addSubjectRow();
    }

  }catch(e){
    alert("خطأ في تحميل بيانات الطالب");
    console.log(e);
  }
}

async function quickView(){
  var code = document.getElementById('filter_code').value.trim();
  var div = document.getElementById('quick_result');
  div.innerHTML = "";
  if(!code){
    div.innerHTML = "<span>برجاء إدخال كود الطالب</span>";
    return;
  }
  try{
    var doc = await db.collection("students").doc(code).get();
    if(!doc.exists){
      div.innerHTML = "<span>لا يوجد طالب بهذا الكود</span>";
      return;
    }
    var st = doc.data();
    var html = "<strong>"+(st.name||"")+"</strong><br>";
    html += "الصف: "+(st.grade||"")+" - الشعبة: "+(st.section||"")+"<br>";
    if(st.subjects){
      html += "<table><tr><th>المادة</th><th>الدرجة</th><th>المعلم</th><th>مشرف المادة</th></tr>";
      if(Array.isArray(st.subjects)){
        st.subjects.forEach(function(sub){
          html += "<tr><td>"+(sub.subjectName||"")+
            "</td><td>"+(sub.mark||0)+"/"+(sub.fullMark||0)+
            "</td><td>"+(sub.teacher||"")+
            "</td><td>"+(sub.supervisor||"")+"</td></tr>";
        });
      }else{
        Object.keys(st.subjects).forEach(function(key){
          var sub = st.subjects[key];
          html += "<tr><td>"+key+
            "</td><td>"+(sub.mark||0)+"/"+(sub.fullMark||0)+
            "</td><td>"+(sub.teacher||"")+
            "</td><td>"+(sub.supervisor||"")+"</td></tr>";
        });
      }
      html += "</table>";
    }
    div.innerHTML = html;
  }catch(e){
    div.innerHTML = "خطأ في قراءة بيانات الطالب";
    console.log(e);
  }
}

initSelects();
addSubjectRow();
</script>

</body>
</html>
