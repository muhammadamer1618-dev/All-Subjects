<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المشرف - مدارس الفلاح الأهلية</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Calibri;background:#f4f4f4;margin:0}
.header{background:#1976d2;color:#fff;padding:15px;text-align:center}
.container{max-width:1100px;margin:20px auto;padding:10px}
.box{background:#fff;border-radius:10px;padding:15px;margin-bottom:15px;box-shadow:0 0 8px rgba(0,0,0,0.1)}
h3{color:#1976d2;margin-top:0}
input,select,button{font-family:Calibri;font-size:16px;padding:8px;margin:5px 0;border-radius:6px;border:1px solid #999}
button{cursor:pointer;font-weight:bold}
.btn-primary{background:#1976d2;color:#fff}
.btn-secondary{background:#757575;color:#fff}
.btn-danger{background:#d32f2f;color:#fff}
.btn-save{background:#388e3c;color:#fff;width:100%;padding:12px;font-size:18px;margin-top:10px;border-radius:10px}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{border:1px solid #000;text-align:center;padding:6px}
th{background:#1976d2;color:#fff}
@media(max-width:768px){th,td{font-size:12px}}
</style>
</head>
<body>

<div class="header">
  <h1>مدارس الفلاح الأهلية</h1>
  <h2>لوحة المشرف</h2>
</div>

<div class="container">
  <div class="box">
    <h3>تسجيل بيانات الطالب</h3>
    <label>كود الطالب</label><input id="st_code" placeholder="مثال: 1001">
    <label>اسم الطالب</label><input id="st_name" placeholder="اسم الطالب">
    <label>الصف</label><input id="st_grade" placeholder="مثال: 6 ابتدائي">
    <label>الشعبة</label><input id="st_section" placeholder="مثال: أ">

    <h3>مواد الطالب</h3>
    <table id="subjectsTable">
      <thead>
        <tr>
          <th>المادة</th>
          <th>نوع الاختبار</th>
          <th>الدرجة النهائية</th>
          <th>درجة الطالب</th>
          <th>التقدير</th>
          <th>اسم المعلم</th>
          <th>مشرف المادة</th>
          <th>إزالة</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn-secondary" onclick="addSubject()">إضافة مادة</button>
    <button class="btn-save" onclick="saveStudent()">حفظ الطالب</button>
  </div>

  <div class="box">
    <h3>عرض بيانات الطلاب</h3>
    <input id="filter_code" placeholder="بحث بالكود">
    <button class="btn-primary" onclick="loadStudent()">عرض الطالب</button>
    <div id="studentInfo"></div>
  </div>

  <div class="box">
    <button class="btn-secondary" onclick="location='index.html'">الصفحة الرئيسية</button>
    <button class="btn-secondary" onclick="location='student.html'">صفحة الطالب</button>
  </div>
</div>

<script>
var firebaseConfig={apiKey:"AIzaSyC4-cGVb2pHwo6LYiD-UoWtmEEZKQxj4_M",authDomain:"all-subjects-14322.firebaseapp.com",projectId:"all-subjects-14322",storageBucket:"all-subjects-14322.firebasestorage.app",messagingSenderId:"813955287168",appId:"1:813955287168:web:07efa7dde95b117b9bbe65"};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

function calcRating(mark,full){
  let m=Number(mark),f=Number(full);
  if(!m||!f)return"";
  let p=(m/f)*100;
  if(p>=90)return"ممتاز";
  if(p>=80)return"جيد جدًا";
  if(p>=70)return"جيد";
  if(p>=60)return"مقبول";
  return"ضعيف";
}

function addSubject(){
  let tr=document.createElement("tr");
  tr.innerHTML=`
  <td><input class='subject'></td>
  <td><input class='exam'></td>
  <td><input type='number' class='full'></td>
  <td><input type='number' class='mark' oninput='updateRating(this)'></td>
  <td class='rating'></td>
  <td><input class='teacher'></td>
  <td><input class='supervisor'></td>
  <td><button class='btn-danger' onclick='this.parentElement.parentElement.remove()'>حذف</button></td>`;
  document.querySelector("#subjectsTable tbody").appendChild(tr);
}

function updateRating(el){
  let row=el.parentElement.parentElement;
  let mark=row.querySelector(".mark").value;
  let full=row.querySelector(".full").value;
  row.querySelector(".rating").innerText=calcRating(mark,full);
}

async function saveStudent(){
  let code=document.getElementById("st_code").value.trim();
  let name=document.getElementById("st_name").value.trim();
  if(!code||!name){alert("يرجى إدخال الكود والاسم");return;}
  let grade=document.getElementById("st_grade").value.trim();
  let section=document.getElementById("st_section").value.trim();

  let subs={};
  document.querySelectorAll("#subjectsTable tbody tr").forEach(tr=>{
    let subj=tr.querySelector(".subject").value.trim();
    if(!subj)return;
    subs[subj]={
      exam:tr.querySelector(".exam").value.trim(),
      fullMark:Number(tr.querySelector(".full").value),
      mark:Number(tr.querySelector(".mark").value),
      rating:tr.querySelector(".rating").innerText,
      teacher:tr.querySelector(".teacher").value.trim(),
      supervisor:tr.querySelector(".supervisor").value.trim()
    };
  });

  try{
    await db.collection("students").doc(code).set({name:name,grade:grade,section:section,subjects:subs});
    alert("تم حفظ بيانات الطالب بنجاح");
  }catch(e){alert("حدث خطأ أثناء الحفظ");console.log(e);}
}

async function loadStudent(){
  let code=document.getElementById("filter_code").value.trim();
  if(!code){alert("أدخل الكود");return;}
  let div=document.getElementById("studentInfo");
  div.innerHTML="";
  let doc=await db.collection("students").doc(code).get();
  if(!doc.exists){div.innerHTML="<p>الطالب غير موجود</p>";return;}
  let st=doc.data();
  let html=`<h4>${st.name}</h4><table><tr><th>المادة</th><th>الدرجة</th><th>المعلم</th><th>مشرف المادة</th></tr>`;
  for(let s in st.subjects){
    let sb=st.subjects[s];
    html+=`<tr><td>${s}</td><td>${sb.mark}/${sb.fullMark}</td><td>${sb.teacher}</td><td>${sb.supervisor}</td></tr>`;
  }
  html+="</table>";
  div.innerHTML=html;
}
</script>
</body>
</html>
