<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المشرف - مدارس الفلاح الأهلية</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<!-- Firebase compat SDKs (أسهل طريقة بدون بناء مشروع) -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Calibri;
  background:#f4f4f4;
  margin:0;
}
.header{
  background:#1976d2;color:#fff;
  padding:15px;text-align:center;
}
.header h1{margin:0;font-size:26px;}
.header h2{margin:5px 0 0;font-size:20px;color:#ffeb3b;}
.container{
  max-width:1100px;margin:20px auto;padding:10px;
}
.box{
  background:#fff;border-radius:10px;
  padding:15px;margin-bottom:15px;
  box-shadow:0 0 8px rgba(0,0,0,0.1);
}
.box h3{margin-top:0;color:#1976d2;}
input,select,button{
  font-family:Calibri;
  font-size:16px;
  padding:8px;
  margin:5px 0;
  border-radius:6px;
  border:1px solid #999;
}
input,select{width:100%;box-sizing:border-box;}
button{
  cursor:pointer;border:none;
  font-weight:bold;
}
.btn-primary{background:#1976d2;color:#fff;}
.btn-danger{background:#d32f2f;color:#fff;}
.btn-secondary{background:#757575;color:#fff;}
.btn-save-marks{
  width:100%;padding:12px;
  margin-top:10px;font-size:18px;
  border-radius:10px;
  background:#388e3c;color:#fff;
}
.row{
  display:flex;flex-wrap:wrap;gap:10px;
}
.col-3{flex:1 1 23%;}
.col-4{flex:1 1 30%;}
.col-6{flex:1 1 48%;}
.col-12{flex:1 1 100%;}
@media(max-width:768px){
  .col-3,.col-4,.col-6{flex:1 1 100%;}
}
table{
  width:100%;border-collapse:collapse;
  margin-top:10px;font-size:14px;
}
th,td{
  border:1px solid #000;
  text-align:center;
  padding:6px;
}
th{
  background:#1976d2;color:#fff;
}
.mark-input{
  width:70px;
}
.rating-cell{
  font-weight:bold;
}
</style>
</head>
<body>

<div class="header">
  <h1>مدارس الفلاح الأهلية</h1>
  <h2>لوحة المشرف - شهادات المواد الدراسية</h2>
</div>

<div class="container">

  <!-- تسجيل / تعديل الطالب -->
  <div class="box">
    <h3>تسجيل / تعديل بيانات الطالب (مرة واحدة لكل مادة)</h3>
    <div class="row">
      <div class="col-3">
        <label>كود الطالب</label>
        <input id="st_code" placeholder="مثال: 1001">
      </div>
      <div class="col-3">
        <label>اسم الطالب</label>
        <input id="st_name" placeholder="اسم الطالب">
      </div>
      <div class="col-3">
        <label>الصف</label>
        <select id="st_grade"></select>
      </div>
      <div class="col-3">
        <label>الشعبة</label>
        <select id="st_section">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <div class="col-3">
        <label>المادة</label>
        <select id="st_subject"></select>
      </div>
      <div class="col-3">
        <label>نوع الاختبار</label>
        <input id="st_examType" placeholder="نهائي / فترة / قصير">
      </div>
      <div class="col-3">
        <label>الدرجة النهائية</label>
        <input id="st_fullMark" type="number" placeholder="مثال: 20">
      </div>
      <div class="col-3">
        <label>اسم المعلم</label>
        <input id="st_teacher" placeholder="اسم المعلم">
      </div>
    </div>

    <div class="row">
      <div class="col-6">
        <button class="btn-primary" onclick="saveStudent()">حفظ / تحديث الطالب</button>
      </div>
      <div class="col-6">
        <button class="btn-secondary" onclick="clearForm()">تفريغ النموذج</button>
      </div>
    </div>
  </div>

  <!-- كشف الطلاب / رصد الدرجات -->
  <div class="box">
    <h3>كشف الطلاب ورصد الدرجات</h3>
    <div class="row">
      <div class="col-3">
        <label>الصف</label>
        <select id="filter_grade">
          <option value="">كل الصفوف</option>
        </select>
      </div>
      <div class="col-3">
        <label>الشعبة</label>
        <select id="filter_section">
          <option value="">كل الشعب</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
      <div class="col-3">
        <label>المادة</label>
        <select id="filter_subject">
          <option value="">كل المواد</option>
        </select>
      </div>
      <div class="col-3">
        <label>بحث بالكود</label>
        <input id="filter_code" placeholder="كود الطالب">
      </div>
    </div>

    <div class="row">
      <div class="col-3">
        <label>بحث بالاسم</label>
        <input id="filter_name" placeholder="جزء من الاسم">
      </div>
      <div class="col-3">
        <button class="btn-primary" style="margin-top:25px" onclick="loadStudents()">عرض كشف الطلاب</button>
      </div>
      <div class="col-3">
        <button class="btn-secondary" style="margin-top:25px" onclick="reloadAll()">تحديث البيانات من السحابة</button>
      </div>
      <div class="col-3">
        <span style="font-size:13px;color:#555;display:block;margin-top:25px;">
          ملاحظة: رصد الدرجات يكون بإدخال درجة الطالب فقط، ثم الضغط على حفظ جميع الدرجات.
        </span>
      </div>
    </div>

    <table id="students_table">
      <thead>
        <tr>
          <th>الكود</th>
          <th>اسم الطالب</th>
          <th>الصف</th>
          <th>الشعبة</th>
          <th>المادة</th>
          <th>المعلم</th>
          <th>نوع الاختبار</th>
          <th>الدرجة النهائية</th>
          <th>درجة الطالب</th>
          <th>التقدير</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="students_body"></tbody>
    </table>

    <button class="btn-save-marks" onclick="saveAllMarks()">حفظ جميع الدرجات</button>
  </div>

  <div class="box">
    <button class="btn-secondary" onclick="location='index.html'">العودة للصفحة الرئيسية</button>
    <button class="btn-secondary" onclick="location='student.html'">صفحة الطالب</button>
  </div>

</div>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyC4-cGVb2pHwo6LYiD-UoWtmEEZKQxj4_M",
  authDomain: "all-subjects-14322.firebaseapp.com",
  projectId: "all-subjects-14322",
  storageBucket: "all-subjects-14322.firebasestorage.app",
  messagingSenderId: "813955287168",
  appId: "1:813955287168:web:07efa7dde95b117b9bbe65"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

var gradesList = [
  "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
  "1 متوسط","2 متوسط","3 متوسط",
  "1 ثانوي","2 ثانوي","3 ثانوي"
];

var subjectsList = [
  {id:"arabic",  name:"اللغة العربية"},
  {id:"english", name:"اللغة الإنجليزية"},
  {id:"math",    name:"الرياضيات"},
  {id:"science", name:"العلوم"},
  {id:"islamic", name:"التربية الإسلامية"},
  {id:"social",  name:"الدراسات الاجتماعية"}
];

var studentsCache = [];

function initSelects(){
  var stGrade = document.getElementById('st_grade');
  var filterGrade = document.getElementById('filter_grade');
  gradesList.forEach(function(g){
    var o1 = document.createElement("option");
    o1.value = g; o1.textContent = g;
    stGrade.appendChild(o1);

    var o2 = document.createElement("option");
    o2.value = g; o2.textContent = g;
    filterGrade.appendChild(o2);
  });

  var stSubject = document.getElementById('st_subject');
  var filterSubject = document.getElementById('filter_subject');
  subjectsList.forEach(function(s){
    var o1 = document.createElement("option");
    o1.value = s.id; o1.textContent = s.name;
    stSubject.appendChild(o1);

    var o2 = document.createElement("option");
    o2.value = s.id; o2.textContent = s.name;
    filterSubject.appendChild(o2);
  });
}

function findSubjectName(id){
  var f = subjectsList.find(function(s){return s.id===id;});
  return f ? f.name : "";
}

function calcRating(mark, full){
  var m = Number(mark);
  var f = Number(full);
  if(!m || !f) return "";
  var p = (m/f)*100;
  if(p>=90) return "ممتاز";
  if(p>=80) return "جيد جدًا";
  if(p>=70) return "جيد";
  if(p>=60) return "مقبول";
  return "ضعيف";
}

function clearForm(){
  document.getElementById('st_code').value = "";
  document.getElementById('st_code').disabled = false;
  document.getElementById('st_name').value = "";
  document.getElementById('st_grade').value = gradesList[0];
  document.getElementById('st_section').value = "1";
  document.getElementById('st_teacher').value = "";
  document.getElementById('st_examType').value = "";
  document.getElementById('st_fullMark').value = "";
  document.getElementById('st_subject').value = subjectsList[0].id;
}

async function saveStudent(){
  var code = document.getElementById('st_code').value.trim();
  var name = document.getElementById('st_name').value.trim();
  var grade = document.getElementById('st_grade').value;
  var section = document.getElementById('st_section').value;
  var teacher = document.getElementById('st_teacher').value.trim();
  var examType = document.getElementById('st_examType').value.trim();
  var fullMark = Number(document.getElementById('st_fullMark').value);
  var subjectId = document.getElementById('st_subject').value;

  if(!code || !name){
    alert("برجاء إدخال كود الطالب واسم الطالب");
    return;
  }

  var subjectName = findSubjectName(subjectId);

  var data = {
    code: code,
    name: name,
    grade: grade,
    section: section,
    teacher: teacher,
    examType: examType,
    fullMark: isNaN(fullMark) ? 0 : fullMark,
    subjectId: subjectId,
    subjectName: subjectName
  };

  var docId = code + "_" + subjectId;

  try{
    await db.collection("results").doc(docId).set(data,{merge:true});
    alert("تم حفظ / تحديث بيانات الطالب بنجاح");
    loadStudents();
  }catch(e){
    alert("خطأ في حفظ بيانات الطالب");
    console.log(e);
  }
}

async function loadStudents(){
  var filterGrade = document.getElementById('filter_grade').value;
  var filterSection = document.getElementById('filter_section').value;
  var filterSubject = document.getElementById('filter_subject').value;
  var searchCode = document.getElementById('filter_code').value.trim();
  var searchName = document.getElementById('filter_name').value.trim();

  var tbody = document.getElementById('students_body');
  tbody.innerHTML = "";
  studentsCache = [];

  try{
    var ref = db.collection("results");
    if(filterGrade){
      ref = ref.where("grade","==",filterGrade);
    }
    if(filterSubject){
      ref = ref.where("subjectId","==",filterSubject);
    }
    var snap = await ref.get();
    snap.forEach(function(doc){
      var s = doc.data();
      s.docId = doc.id;
      studentsCache.push(s);
    });

    var filtered = studentsCache.filter(function(s){
      if(filterSection && s.section !== filterSection) return false;
      if(searchCode && s.code.indexOf(searchCode) === -1) return false;
      if(searchName && (!s.name || s.name.indexOf(searchName) === -1)) return false;
      return true;
    });

    filtered.forEach(function(s){
      var tr = document.createElement("tr");
      var markVal = (s.mark !== undefined && s.mark !== null) ? s.mark : "";
      var rating = calcRating(markVal, s.fullMark);

      tr.innerHTML =
        "<td>"+(s.code||"")+"</td>"+
        "<td>"+(s.name||"")+"</td>"+
        "<td>"+(s.grade||"")+"</td>"+
        "<td>"+(s.section||"")+"</td>"+
        "<td>"+(s.subjectName||"")+"</td>"+
        "<td>"+(s.teacher||"")+"</td>"+
        "<td>"+(s.examType||"")+"</td>"+
        "<td>"+(s.fullMark||"")+"</td>"+
        "<td><input class='mark-input' data-docid='"+s.docId+"' data-full='"+(s.fullMark||0)+"' value='"+markVal+"'></td>"+
        "<td class='rating-cell' id='rating_"+s.docId+"'>"+rating+"</td>"+
        "<td>"+
          "<button class='btn-secondary' style='margin-bottom:3px;' onclick='fillForm(\""+s.docId+"\")'>تعديل</button><br>"+
          "<button class='btn-danger' onclick='deleteStudent(\""+s.docId+"\")'>حذف</button>"+
        "</td>";

      tbody.appendChild(tr);
    });

  }catch(e){
    alert("خطأ في تحميل الطلاب");
    console.log(e);
  }
}

function reloadAll(){
  document.getElementById('filter_grade').value = "";
  document.getElementById('filter_section').value = "";
  document.getElementById('filter_subject').value = "";
  document.getElementById('filter_code').value = "";
  document.getElementById('filter_name').value = "";
  loadStudents();
}

async function fillForm(docId){
  try{
    var doc = await db.collection("results").doc(docId).get();
    if(!doc.exists){
      alert("السجل غير موجود");
      return;
    }
    var s = doc.data();
    document.getElementById('st_code').value = s.code || "";
    document.getElementById('st_code').disabled = false;
    document.getElementById('st_name').value = s.name || "";
    document.getElementById('st_grade').value = s.grade || gradesList[0];
    document.getElementById('st_section').value = s.section || "1";
    document.getElementById('st_teacher').value = s.teacher || "";
    document.getElementById('st_examType').value = s.examType || "";
    document.getElementById('st_fullMark').value = s.fullMark || "";
    document.getElementById('st_subject').value = s.subjectId || subjectsList[0].id;
    window.scrollTo({top:0,behavior:"smooth"});
  }catch(e){
    alert("خطأ في جلب بيانات السجل");
    console.log(e);
  }
}

async function deleteStudent(docId){
  if(!confirm("هل تريد حذف هذا السجل؟")) return;
  try{
    await db.collection("results").doc(docId).delete();
    alert("تم حذف السجل");
    loadStudents();
  }catch(e){
    alert("خطأ في حذف السجل");
    console.log(e);
  }
}

async function saveAllMarks(){
  var inputs = document.querySelectorAll(".mark-input");
  var batch = db.batch();
  var changed = 0;

  inputs.forEach(function(inp){
    var docId = inp.getAttribute("data-docid");
    var full = Number(inp.getAttribute("data-full"));
    var val = inp.value.trim();
    if(val === "") return;
    var m = Number(val);
    if(isNaN(m)) return;
    var ref = db.collection("results").doc(docId);
    batch.update(ref,{mark:m, fullMark:isNaN(full)?0:full});
    changed++;
  });

  if(changed === 0){
    alert("لا توجد درجات لحفظها");
    return;
  }

  try{
    await batch.commit();
    alert("تم حفظ جميع الدرجات");
    loadStudents();
  }catch(e){
    alert("خطأ في حفظ الدرجات");
    console.log(e);
  }
}

initSelects();
loadStudents();
</script>

</body>
</html>
